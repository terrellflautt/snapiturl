<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>SnapIT URL - Premium URL Shortener with Analytics & QR Codes</title>
    <meta name="description" content="Shorten URLs with custom branding, real-time analytics, and integrated QR code generation. The ultimate URL shortening solution for businesses and marketers.">
    <meta name="keywords" content="URL shortener, short links, link shortening, URL analytics, branded URLs, QR codes, business link management">
    <meta name="author" content="SnapIT Software">

    <!-- Open Graph -->
    <meta property="og:title" content="SnapIT URL - Premium URL Shortener">
    <meta property="og:description" content="Shorten URLs with custom branding, real-time analytics, and integrated QR code generation.">
    <meta property="og:image" content="https://snapiturl.com/og-image.png">
    <meta property="og:url" content="https://snapiturl.com">
    <meta property="og:type" content="website">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Relaxed CSP to prevent unnecessary blocking -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; style-src 'self' 'unsafe-inline' https: data:; connect-src 'self' https: wss: data:; font-src 'self' https: data:; img-src 'self' https: data: blob:; frame-src 'self' https:; media-src 'self' https: data: blob:; object-src 'none'; base-uri 'self';"
    
    <!-- Preconnects -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://accounts.google.com">
    <link rel="preconnect" href="https://api.snapitqr.com">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Configuration (must be loaded first) -->
    <script src="config.js"></script>

    <!-- External Scripts -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Stripe for payment processing -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer onload="window.qriousLoaded = true;" onerror="console.error('Failed to load QRious library');"></script>
    
    <!-- Minimal Error Logging -->
    <script>
    (function() {
        'use strict';

        // Simple console log for initialization
        console.log('SnapIT QR - Application Initializing');

        // Payment system status
        window.addEventListener('load', function() {
            setTimeout(function() {
                console.log('💳 Payment system initialized');
            }, 2000);
        });
    })();
    </script>
    
    <style>
        :root {
            /* SnapIT Brand Colors - Match SnapIT Polls, Burn, Forums */
            --primary: #E91E63;
            --primary-gradient: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
            --primary-solid: #E91E63;
            --primary-dark: #C2185B;
            --primary-light: #F06292;
            --secondary: #000000;
            --accent: #FFF9C4;
            --accent-dark: #FFF59D;

            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3af;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Spacing */
            --space-2: 0.5rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;
            --space-16: 4rem;
            --space-20: 5rem;
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: #FFF5F7;
            background-size: 400% 400%;
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glass Morphism Overlay */
        /* Removed blurry overlay */

        .container {
            position: relative;
            z-index: 2;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }

        /* Professional Top Navigation */
        .header {
            position: relative;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: var(--shadow-2xl);
            padding: var(--space-4) var(--space-6);
            transition: all 0.3s ease;
            width: auto;
            max-width: calc(100vw - 2rem);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-6);
            white-space: nowrap;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 900;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex-shrink: 0;
        }

        .logo::before {
            content: "📱";
            font-size: 1.5rem;
            background: var(--primary);
            border-radius: var(--radius-lg);
            padding: 0.25rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            flex-wrap: wrap;
        }

        .nav-link {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-lg);
            white-space: nowrap;
        }

        .nav-link:hover {
            color: var(--primary-solid);
            background: rgba(170, 51, 106, 0.1);
            transform: translateY(-1px);
        }

        /* Responsive floating nav */
        @media (max-width: 768px) {
            .header {
                top: var(--space-2);
                padding: var(--space-3) var(--space-4);
                max-width: calc(100vw - 1rem);
            }

            .header-content {
                gap: var(--space-3);
            }

            .nav-menu {
                gap: var(--space-2);
            }

            .nav-link {
                font-size: 0.8rem;
                padding: var(--space-1) var(--space-2);
            }

            .logo {
                font-size: 1.25rem;
            }
        }

        /* Hero Section */
        .hero {
            padding: var(--space-20) 0 var(--space-16);
            text-align: center;
        }

        .hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 900;
            color: #1e293b;
            margin-bottom: var(--space-6);
            line-height: 1.1;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto var(--space-8);
            font-weight: 400;
        }

        .hero-features {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: var(--space-6);
            margin-bottom: var(--space-12);
        }

        .hero-feature {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            background: rgba(255, 255, 255, 0.8);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-xl);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Glass Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            padding: var(--space-8);
            margin-bottom: var(--space-8);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
            margin-bottom: var(--space-12);
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .card-icon {
            width: 3rem;
            height: 3rem;
            background: var(--primary);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
            font-size: 0.9rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: var(--space-4);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-family: var(--font-family);
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-solid);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-4) var(--space-6);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            font-family: var(--font-family);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: #10b981;
            color: white;
        }

        .badge-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover:not(:disabled) {
            background: white;
            border-color: var(--primary-solid);
            color: var(--primary-solid);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-full {
            width: 100%;
        }

        .btn-lg {
            padding: var(--space-6) var(--space-8);
            font-size: 1.125rem;
        }

        /* Template Buttons */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-2);
            margin-bottom: var(--space-6);
        }

        .template-btn {
            padding: var(--space-2) var(--space-4);
            border: 2px solid var(--gray-200);
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            text-align: center;
        }

        .template-btn:hover {
            border-color: var(--primary-solid);
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        /* Color Picker */
        .color-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .color-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .color-input {
            width: 50px;
            height: 50px;
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-input:hover {
            border-color: var(--primary-solid);
            transform: scale(1.05);
        }

        /* QR Preview */
        .qr-preview {
            background: rgba(248, 250, 252, 0.8);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
            margin-bottom: var(--space-6);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-preview img,
        .qr-preview canvas {
            max-width: 100%;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .qr-placeholder {
            color: var(--gray-500);
            font-size: 1.125rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
        }

        .qr-placeholder::before {
            content: "📱";
            font-size: 3rem;
            opacity: 0.5;
        }

        /* QR Actions */
        .qr-actions {
            display: none;
            flex-direction: row;
            flex-wrap: wrap;
            gap: var(--space-2);
            justify-content: center;
        }

        .qr-actions.show {
            display: flex;
        }

        /* Auth Section */
        .auth-section {
            text-align: center;
            padding: var(--space-8);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            margin-bottom: var(--space-12);
        }

        .auth-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-4);
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-benefits {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: var(--space-4);
            margin-top: var(--space-6);
        }

        .auth-benefit {
            background: rgba(102, 126, 234, 0.1);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            color: var(--primary-dark);
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* User Menu */
        .user-menu {
            display: none;
        }

        .user-menu.active {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-solid);
        }

        .user-info {
            text-align: right;
        }

        .user-email {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .user-plan {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Features Section */
        .features-section {
            padding: var(--space-20) 0;
        }

        .features-header {
            text-align: center;
            margin-bottom: var(--space-16);
        }

        .features-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: var(--space-4);
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-8);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            text-align: center;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-2xl);
        }

        .feature-icon {
            width: 4rem;
            height: 4rem;
            background: var(--primary);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin: 0 auto var(--space-4);
        }

        .feature-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .feature-description {
            color: var(--gray-600);
            line-height: 1.6;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-xl);
            padding: var(--space-4) var(--space-6);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--error);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        .toast-info {
            border-left: 4px solid var(--info);
        }

        /* URL Results */
        .url-result {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-top: var(--space-6);
            text-align: center;
        }

        .url-result h4 {
            color: var(--success);
            margin-bottom: var(--space-4);
            font-size: 1.125rem;
        }

        .shortened-url {
            background: white;
            border: 2px solid var(--success);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .shortened-url-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-solid);
            font-family: monospace;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .nav-menu {
                gap: var(--space-2);
            }
            
            .nav-link {
                padding: var(--space-2);
                font-size: 0.875rem;
            }
            
            .hero {
                padding: var(--space-12) 0 var(--space-8);
            }
            
            .glass-card {
                padding: var(--space-4);
            }
            
            .color-controls {
                grid-template-columns: 1fr;
            }
            
            .auth-benefits {
                flex-direction: column;
                align-items: center;
            }
        }
        
        /* Loading State */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-solid);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Upgrade Modal Styles */
        .upgrade-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: var(--space-4);
        }

        .upgrade-modal.show {
            opacity: 1;
        }

        .upgrade-modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-8);
            border-bottom: 2px solid var(--gray-100);
            padding-bottom: var(--space-4);
        }

        .upgrade-header h2 {
            font-size: 2rem;
            font-weight: 900;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--gray-400);
            padding: 0.5rem;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-6);
        }

        .pricing-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-solid);
        }

        .pricing-card.popular {
            border-color: var(--primary-solid);
            border-width: 3px;
            transform: scale(1.05);
        }

        .popular-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .pricing-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-4);
            color: var(--gray-900);
        }

        .pricing-card .price {
            font-size: 2.5rem;
            font-weight: 900;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-6);
        }

        .pricing-card .price span {
            font-size: 1rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .pricing-card ul {
            list-style: none;
            padding: 0;
            margin: 0 0 var(--space-6) 0;
            text-align: left;
        }

        .pricing-card li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .pricing-card li:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .upgrade-modal-content {
                padding: var(--space-4);
                margin: var(--space-2);
            }
            
            .pricing-grid {
                grid-template-columns: 1fr;
            }
            
            .pricing-card.popular {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="https://snapitqr.com" class="logo">SnapIT QR</a>
                <nav class="nav-menu">
                    <a href="#features" class="nav-link">Features</a>
                    <a href="#pricing" class="nav-link">Pricing</a>
                    <a href="https://snapiturl.com" class="nav-link">URL Shortener</a>
                    
                    <!-- Auth Section -->
                    <div id="authSection" style="display: flex; align-items: center; gap: 1rem;">
                        <div id="signInButton" style="display: flex; align-items: center; gap: 0.5rem;">
                            <div id="g_id_signin"></div>
                            <!-- Custom backup sign-in button -->
                            <button id="customSignInBtn" class="btn-sign-in" onclick="showCustomSignIn()" style="
                                display: inline-flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.625rem 1.25rem;
                                background: white;
                                color: #000;
                                border: 1px solid #E91E63;
                                border-radius: 0.5rem;
                                font-weight: 600;
                                font-size: 0.875rem;
                                cursor: pointer;
                                transition: all 0.2s;
                                white-space: nowrap;
                            " onmouseover="this.style.background='#FFF9C4'; this.style.borderColor='#C2185B';" onmouseout="this.style.background='white'; this.style.borderColor='#E91E63';">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                Sign In
                            </button>
                        </div>
                        <div id="userMenu" class="user-menu" style="display: none;">
                            <div class="user-info">
                                <div id="userEmail" class="user-email"></div>
                                <div id="userPlan" class="user-plan"></div>
                            </div>
                            <img id="userAvatar" class="user-avatar" alt="User">
                            <button class="btn btn-secondary" onclick="signOut()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Sign Out</button>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Hero Section -->
        <section class="hero">
            <h1>Powerful URL Shortener<br>with Real-Time Analytics</h1>
            <p class="hero-subtitle">Create branded short links with custom domains, real-time tracking, and detailed analytics. The ultimate URL shortening solution for businesses and marketers.</p>
            
            <div class="hero-features">
                <div class="hero-feature">
                    <span>⚡</span>
                    <span>Instant Generation</span>
                </div>
                <div class="hero-feature">
                    <span>📊</span>
                    <span>Real-Time Analytics</span>
                </div>
                <div class="hero-feature">
                    <span>🎨</span>
                    <span>Custom Branding</span>
                </div>
                <div class="hero-feature">
                    <span>🔗</span>
                    <span>URL Shortening</span>
                </div>
            </div>
        </section>

        <!-- Auth Section (Hidden by default - shown only when not signed in) -->
        <section class="auth-section" id="authCard" style="display: none;">
            <h3>🚀 Sign In to Save & Manage</h3>
            <p style="color: var(--gray-600); margin-bottom: var(--space-6);">Sign in to save your short URLs, track analytics, and generate QR codes</p>
            <div id="g_id_signin_alt" style="display: inline-block;"></div>

            <div class="auth-benefits">
                <div class="auth-benefit">✨ Branded Short Links</div>
                <div class="auth-benefit">📈 Detailed Analytics</div>
                <div class="auth-benefit">🔗 URL Shortening</div>
                <div class="auth-benefit">🎨 Custom Branding</div>
            </div>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="dashboard glass-card">
            <div class="card-header">
                <div class="card-icon">📊</div>
                <h2 class="card-title">Your Dashboard</h2>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="qrCount">0</span>
                    <span class="stat-label">Short URLs Created</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="urlCount">0</span>
                    <span class="stat-label">Short Links Created</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="totalClicks">0</span>
                    <span class="stat-label">Total Clicks</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="currentPlan">Free</span>
                    <span class="stat-label">Current Plan</span>
                </div>
            </div>

            <div style="text-align: center; display: flex; gap: var(--space-4); justify-content: center; flex-wrap: wrap; margin-bottom: var(--space-6);">
                <button class="btn btn-secondary" onclick="refreshDashboard()">🔄 Refresh Data</button>
                <button class="btn btn-secondary" onclick="showBulkUploadModal()">📤 Bulk Upload</button>
                <button class="btn btn-primary" onclick="showUpgradeModal()">⭐ Upgrade Plan</button>
            </div>

            <!-- Tabs for QR Codes and Short URLs -->
            <div class="dashboard-tabs" style="margin-top: var(--space-6);">
                <div class="tab-buttons" style="display: flex; gap: var(--space-2); border-bottom: 2px solid var(--gray-200); margin-bottom: var(--space-4);">
                    <button class="tab-btn active" onclick="switchDashboardTab('qr')" id="qrTab" style="padding: var(--space-3) var(--space-6); background: none; border: none; border-bottom: 3px solid var(--primary); font-weight: 600; color: var(--primary); cursor: pointer; font-size: 1rem;">
                        📋 My QR Codes
                    </button>
                    <button class="tab-btn" onclick="switchDashboardTab('urls')" id="urlsTab" style="padding: var(--space-3) var(--space-6); background: none; border: none; border-bottom: 3px solid transparent; font-weight: 500; color: var(--gray-600); cursor: pointer; font-size: 1rem;">
                        🔗 My Short Links
                    </button>
                </div>

                <!-- QR Codes Tab Content -->
                <div id="qrCodesList" class="tab-content">
                    <div id="qrCodesContainer">
                        <p style="color: var(--gray-500); text-align: center; padding: var(--space-8);">
                            No QR codes yet. Create your first QR code above! 👆
                        </p>
                    </div>
                </div>

                <!-- Short URLs Tab Content -->
                <div id="shortUrlsList" class="tab-content" style="display: none;">
                    <div id="shortUrlsContainer">
                    <p style="color: var(--gray-500); text-align: center; padding: var(--space-8);">
                        No short links yet. Create your first short link above! 👆
                    </p>
                </div>
            </div>
        </section>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- QR Code Generator -->
            <div class="glass-card">
                <div class="card-header">
                    <div class="card-icon">🎯</div>
                    <h2 class="card-title">QR Code Generator</h2>
                </div>
                
                <!-- Quick Templates -->
                <div class="form-group">
                    <label class="form-label">Quick Templates</label>
                    <div class="template-grid">
                        <button class="template-btn" onclick="loadTemplate('website')">🌐 Website</button>
                        <button class="template-btn" onclick="loadTemplate('email')">📧 Email</button>
                        <button class="template-btn" onclick="loadTemplate('phone')">📞 Phone</button>
                        <button class="template-btn" onclick="loadTemplate('wifi')">📶 WiFi</button>
                        <button class="template-btn" onclick="loadTemplate('text')">📝 Text</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="qrContent" class="form-label">Content</label>
                    <textarea id="qrContent" class="form-textarea" placeholder="Enter URL, text, or any content..." rows="3" oninput="debouncedGenerateQR()"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Colors</label>
                    <div class="color-controls">
                        <div class="color-group">
                            <label for="fgColor" class="form-label" style="margin-bottom: 0;">Foreground</label>
                            <input type="color" id="fgColor" value="#000000" class="color-input" onchange="generateQRCode()">
                        </div>
                        <div class="color-group">
                            <label for="bgColor" class="form-label" style="margin-bottom: 0;">Background</label>
                            <input type="color" id="bgColor" value="#FFFFFF" class="color-input" onchange="generateQRCode()">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="qrSize" class="form-label">Size</label>
                    <select id="qrSize" class="form-select" onchange="generateQRCode()">
                        <option value="200">Small (200×200)</option>
                        <option value="300" selected>Medium (300×300)</option>
                        <option value="400">Large (400×400)</option>
                        <option value="500">Extra Large (500×500)</option>
                    </select>
                </div>

                <!-- Border Customization -->
                <div class="form-group">
                    <label class="form-label">Border</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label for="borderWidth" class="form-label" style="margin-bottom: 5px; font-size: 0.9rem;">Thickness (px)</label>
                            <input type="number" id="borderWidth" class="form-select" value="0" min="0" max="20" onchange="generateQRCode()">
                        </div>
                        <div>
                            <label for="borderColor" class="form-label" style="margin-bottom: 5px; font-size: 0.9rem;">Color</label>
                            <input type="color" id="borderColor" value="#000000" class="color-input" onchange="generateQRCode()">
                        </div>
                    </div>
                    <div>
                        <label for="borderStyle" class="form-label" style="margin-bottom: 5px; font-size: 0.9rem;">Style</label>
                        <select id="borderStyle" class="form-select" onchange="generateQRCode()">
                            <option value="solid">Solid</option>
                            <option value="dashed">Dashed</option>
                            <option value="dotted">Dotted</option>
                            <option value="double">Double</option>
                        </select>
                    </div>
                </div>

                <!-- Text Above/Below QR Code -->
                <div class="form-group">
                    <label for="qrTextAbove" class="form-label">Text Above QR Code (optional)</label>
                    <input type="text" id="qrTextAbove" class="form-select" placeholder="e.g., Scan to visit our website" maxlength="50" oninput="generateQRCode()">
                </div>

                <div class="form-group">
                    <label for="qrTextBelow" class="form-label">Text Below QR Code (optional)</label>
                    <input type="text" id="qrTextBelow" class="form-select" placeholder="e.g., www.example.com" maxlength="50" oninput="generateQRCode()">
                </div>

                <button id="saveToCloudBtn" class="btn btn-primary btn-full btn-lg" onclick="saveQRCode()">
                    <span>💾 Save QR Code</span>
                </button>
                
                <div id="qrPreview" class="qr-preview">
                    <div class="qr-placeholder">QR code will appear here</div>
                </div>
                
                <div id="qrActions" class="qr-actions">
                    <button id="downloadBtn" class="btn btn-secondary" onclick="downloadQRCode()" disabled>💾 Download</button>
                    <button id="saveBtn" class="btn btn-success" onclick="saveQRCode()" disabled>💾 Save</button>
                    <button id="shareBtn" class="btn btn-secondary" onclick="shareQRCode()" disabled>📤 Share</button>
                </div>
            </div>
            
            <!-- URL Shortener Integration -->
            <div class="glass-card">
                <div class="card-header">
                    <div class="card-icon">🔗</div>
                    <h2 class="card-title">URL Shortener</h2>
                </div>
                
                <p style="color: var(--gray-600); margin-bottom: var(--space-6); font-size: 0.9rem;">
                    Create short URLs using SnapIT URL service and generate QR codes for them instantly.
                </p>
                
                <div class="form-group">
                    <label for="urlToShorten" class="form-label">Long URL</label>
                    <input type="url" id="urlToShorten" class="form-input" placeholder="https://example.com/very-long-url">
                </div>
                
                <div class="form-group">
                    <label for="customAlias" class="form-label">Custom Alias (Optional)</label>
                    <input type="text" id="customAlias" class="form-input" placeholder="my-custom-link">
                    <small style="color: var(--gray-500); font-size: 0.875rem;">Leave empty for auto-generated code (letters, numbers, hyphens only)</small>
                </div>
                
                <div class="form-group">
                    <label for="domainSelect" class="form-label">Domain</label>
                    <select id="domainSelect" class="form-input" style="background-color: white;">
                        <option value="snapitqr.com">snapitqr.com</option>
                        <option value="snapiturl.com">snapiturl.com</option>
                    </select>
                    <small style="color: var(--gray-500); font-size: 0.875rem;">Choose your preferred domain for the short URL</small>
                </div>

                <div class="form-group">
                    <label for="expirationDate" class="form-label">Expiration Date (Optional)</label>
                    <input type="datetime-local" id="expirationDate" class="form-input" style="background-color: white;">
                    <small style="color: var(--gray-500); font-size: 0.875rem;">Leave empty for no expiration. After this date, the short link will no longer work.</small>
                </div>

                <button id="shortenBtn" class="btn btn-primary btn-full btn-lg" onclick="shortenURL()">
                    <span>🚀 Create Short URL</span>
                </button>
                
                <div id="urlResults"></div>
            </div>
        </div>

        <!-- Features Section -->
        <section id="features" class="features-section">
            <div class="features-header">
                <h2 class="features-title">Powerful Features for Modern Businesses</h2>
                <p style="font-size: 1.125rem; color: var(--gray-600); max-width: 600px; margin: 0 auto;">
                    Everything you need to create, track, and manage short URLs at scale
                </p>
            </div>
            
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3 class="feature-title">Lightning Fast</h3>
                    <p class="feature-description">Create short URLs instantly with our optimized global infrastructure and edge computing for lightning-fast link generation.</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <h3 class="feature-title">Advanced Analytics</h3>
                    <p class="feature-description">Track scans, clicks, geographic data, and user engagement with comprehensive real-time analytics dashboards.</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">🎨</div>
                    <h3 class="feature-title">Custom Branding</h3>
                    <p class="feature-description">Create branded short links with custom domains, vanity URLs, and custom slugs that perfectly match your business identity.</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">🔗</div>
                    <h3 class="feature-title">URL Integration</h3>
                    <p class="feature-description">Seamlessly integrate with SnapIT URL for short links, custom domains, and unified link management.</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h3 class="feature-title">Enterprise Security</h3>
                    <p class="feature-description">Bank-level security with encrypted data storage, GDPR compliance, and enterprise-grade privacy protection.</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">🚀</div>
                    <h3 class="feature-title">API Access</h3>
                    <p class="feature-description">Integrate URL shortening into your applications with our comprehensive REST API and SDKs for seamless automation.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer style="background: var(--navy); border-radius: var(--radius-2xl); box-shadow: var(--shadow-xl); padding: var(--space-8); margin: var(--space-20) auto 0; max-width: 1400px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-8); margin-bottom: var(--space-8);">
            <div>
                <h3 style="color: white; margin-bottom: var(--space-4); font-size: 1.25rem; font-weight: 700;">SnapIT QR</h3>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: var(--space-4); line-height: 1.6;">
                    Professional QR code generation with analytics, custom branding, and integrated URL shortening.
                </p>
                <div style="display: flex; gap: var(--space-2);">
                    <a href="https://snapiturl.com" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        🔗 URL Shortener
                    </a>
                    <a href="https://snapitsaas.com" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        💼 Enterprise
                    </a>
                </div>
            </div>

            <div>
                <h4 style="color: white; margin-bottom: var(--space-4); font-weight: 600;">Products</h4>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="margin-bottom: var(--space-2);">
                        <a href="https://snapitqr.com" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">QR Code Generator</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="https://snapiturl.com" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">URL Shortener</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="https://snapitforms.com" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Form Builder</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="https://snapitanalytics.com" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Analytics Platform</a>
                    </li>
                </ul>
            </div>

            <div>
                <h4 style="color: white; margin-bottom: var(--space-4); font-weight: 600;">Resources</h4>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/api-docs" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">API Documentation</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/help" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Help Center</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/tutorials" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Tutorials</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/blog" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Blog</a>
                    </li>
                </ul>
            </div>
            
            <div>
                <h4 style="color: white; margin-bottom: var(--space-4); font-weight: 600;">Support</h4>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/contact" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Contact Us</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/privacy" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Privacy Policy</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/terms" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Terms of Service</a>
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <a href="/status" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#ec4899'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">Service Status</a>
                    </li>
                </ul>
            </div>
        </div>

        <div style="border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: var(--space-6); text-align: center;">
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem; margin: 0;">
                © 2025 SnapIT Software. All rights reserved. |
                <span style="color: #ec4899; font-weight: 600;">Shared subscriptions across all SnapIT products</span>
            </p>
        </div>
    </footer>

    <!-- Contact Form Modal -->
    <div id="contactModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 10000; opacity: 0; transition: opacity 0.3s ease;">
        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); transition: transform 0.3s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.5rem; color: var(--gray-800);">Contact Us</h2>
                <button onclick="closeContactModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--gray-400); line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>

            <form id="contactForm" onsubmit="submitContactForm(event)" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" name="access_key" value="941dde05-6699-4793-b170-fb81b1659e32">
                <input type="hidden" name="subject" value="SnapIT QR Contact Form Submission">
                <input type="hidden" name="from_name" value="SnapIT QR Contact">

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Name</label>
                    <input type="text" name="name" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--primary-solid)'" onblur="this.style.borderColor='var(--gray-300)'">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Email</label>
                    <input type="email" name="email" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--primary-solid)'" onblur="this.style.borderColor='var(--gray-300)'">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Message</label>
                    <textarea name="message" required rows="5" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 1rem; resize: vertical; font-family: inherit; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--primary-solid)'" onblur="this.style.borderColor='var(--gray-300)'"></textarea>
                </div>

                <button type="submit" id="contactSubmitBtn" style="width: 100%; padding: 0.875rem; background: var(--primary-solid); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    Send Message
                </button>
            </form>
        </div>
    </div>

    <!-- Feedback Form Modal -->
    <div id="feedbackModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 10000; opacity: 0; transition: opacity 0.3s ease;">
        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); transition: transform 0.3s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.5rem; color: var(--gray-800);">Send Feedback</h2>
                <button onclick="closeFeedbackModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--gray-400); line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>

            <form id="feedbackForm" onsubmit="submitFeedbackForm(event)" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" name="access_key" value="941dde05-6699-4793-b170-fb81b1659e32">
                <input type="hidden" name="subject" value="SnapIT QR Feedback Submission">
                <input type="hidden" name="from_name" value="SnapIT QR Feedback">

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Your Email (optional)</label>
                    <input type="email" name="email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--primary-solid)'" onblur="this.style.borderColor='var(--gray-300)'" placeholder="Leave blank to stay anonymous">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Feedback Type</label>
                    <select name="feedback_type" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; background: white;" onfocus="this.style.borderColor='var(--primary-solid)'" onblur="this.style.borderColor='var(--gray-300)'">
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="improvement">Improvement Suggestion</option>
                        <option value="compliment">Compliment</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Your Feedback</label>
                    <textarea name="feedback" required rows="5" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 1rem; resize: vertical; font-family: inherit; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--primary-solid)'" onblur="this.style.borderColor='var(--gray-300)'" placeholder="Tell us what you think..."></textarea>
                </div>

                <button type="submit" id="feedbackSubmitBtn" style="width: 100%; padding: 0.875rem; background: var(--primary-solid); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    Submit Feedback
                </button>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let currentQR = null;
        let dynamicQRs = [];
        let staticQRs = [];
        let shortUrls = [];
        let qrGenerateTimeout = null;

        // Debounced QR generation (waits 1 second after user stops typing)
        function debouncedGenerateQR() {
            clearTimeout(qrGenerateTimeout);
            qrGenerateTimeout = setTimeout(() => {
                generateQRCode();
            }, 1000);
        }

        // Initialize app
        window.onload = function() {
            console.log('SnapIT QR initializing...');
            checkExistingSession();
            initGoogleAuth();
            console.log('SnapIT QR initialized');
        };

        // Initialize Google Authentication with shared client ID
        function initGoogleAuth() {
            if (window.google && window.google.accounts) {
                window.google.accounts.id.initialize({
                    client_id: window.SNAPIT_CONFIG?.GOOGLE_CLIENT_ID || 'GOOGLE_CLIENT_ID_NOT_CONFIGURED',
                    callback: handleGoogleSignIn,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });

                // Render sign-in buttons
                const signInElements = ['g_id_signin', 'g_id_signin_alt'];
                let googleButtonRendered = false;
                signInElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        window.google.accounts.id.renderButton(element, {
                            theme: 'outline',
                            size: 'large',
                            text: 'sign_in_with',
                            shape: 'rectangular'
                        });
                        googleButtonRendered = true;
                    }
                });

                // Hide custom button if Google button rendered successfully
                if (googleButtonRendered) {
                    const customBtn = document.getElementById('customSignInBtn');
                    if (customBtn) customBtn.style.display = 'none';
                }

                console.log('Google Sign-In initialized');
            } else {
                console.warn('Google Sign-In not available, retrying...');
                // Show custom button if Google fails after 3 seconds
                setTimeout(() => {
                    if (!window.google || !window.google.accounts) {
                        console.log('Google Sign-In failed to load - showing custom button');
                        const customBtn = document.getElementById('customSignInBtn');
                        if (customBtn) {
                            customBtn.style.display = 'inline-flex';
                            customBtn.title = 'Sign in to save and manage your QR codes';
                        }
                    } else {
                        initGoogleAuth(); // Retry once more
                    }
                }, 3000);
            }
        }

        // Handle Google Sign-In with unified backend authentication
        async function handleGoogleSignIn(response) {
            console.log('Google Sign-In response received');

            if (!response.credential) {
                showToast('No authentication credential received', 'error');
                return;
            }

            try {
                showToast('Authenticating...', 'info');

                // Use SnapIT QR authentication backend directly
                const authResponse = await fetch(`${window.SNAPIT_CONFIG.API_BASE_URL}/auth/google`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: response.credential,
                            action: 'login'
                        })
                    });

                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    if (authData.success) {
                        localStorage.setItem('snapitqr_token', authData.token);
                        localStorage.setItem('snapitqr_user', JSON.stringify(authData.user));

                        currentUser = authData.user;
                        updateAuthUI(authData.user);

                        showToast(`Welcome ${authData.user.name}!`, 'success');
                        refreshDashboard();
                        return;
                    }
                }

                showToast('Sign-in failed. Please try again.', 'error');
            } catch (error) {
                console.error('Authentication error:', error);
                showToast(`Sign-in failed: ${error.message}`, 'error');
            }
        }

        // Check for existing session (unified or local)
        function checkExistingSession() {
            // Check for unified authentication first
            const unifiedUserData = localStorage.getItem('snapit_user_data');
            const accessKey = localStorage.getItem('accessKey');

            if (unifiedUserData && accessKey) {
                try {
                    const user = JSON.parse(unifiedUserData);
                    currentUser = { ...user, accessKey: accessKey };
                    updateAuthUI(user);
                    console.log('Restored unified SnapIT session');
                    return;
                } catch (error) {
                    console.error('Failed to restore unified session:', error);
                    localStorage.removeItem('snapit_user_data');
                    localStorage.removeItem('accessKey');
                }
            }

            // Fallback to local QR authentication
            const userData = localStorage.getItem('snapitqr_user');
            const authToken = localStorage.getItem('snapitqr_token');

            if (userData && authToken) {
                try {
                    const user = JSON.parse(userData);
                    updateAuthUI(user);
                    console.log('Restored local QR session');
                } catch (error) {
                    console.error('Failed to restore local session:', error);
                    localStorage.removeItem('snapitqr_user');
                    localStorage.removeItem('snapitqr_token');
                }
            }
        }

        // Update UI for authenticated user
        function updateAuthUI(user) {
            currentUser = user;

            // Hide auth card and sign-in buttons
            document.getElementById('authCard').style.display = 'none';
            document.getElementById('signInButton').style.display = 'none';

            // Show user menu
            const userMenu = document.getElementById('userMenu');
            userMenu.style.display = 'flex';
            userMenu.classList.add('active');

            // Update user info
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').src = user.picture;
            document.getElementById('userPlan').textContent = `${user.plan || 'Free'} Plan`;

            // Show dashboard
            document.getElementById('dashboard').classList.add('show');
        }

        // Show custom sign-in prompt
        function showCustomSignIn() {
            // Try to trigger Google One Tap if available
            if (window.google && window.google.accounts && window.google.accounts.id) {
                try {
                    window.google.accounts.id.prompt();
                } catch (error) {
                    console.warn('Google One Tap not available, showing auth card');
                }
            }

            // Scroll to auth card as fallback
            const authCard = document.getElementById('authCard');
            if (authCard) {
                authCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                authCard.style.animation = 'pulse 1s ease-in-out 2';
            }
        }

        // Sign out (unified)
        function signOut() {
            // Clear unified authentication
            localStorage.removeItem('accessKey');
            localStorage.removeItem('snapit_user_data');

            // Clear local authentication
            localStorage.removeItem('snapitqr_token');
            localStorage.removeItem('snapitqr_user');

            currentUser = null;

            // Show auth card and sign-in button
            document.getElementById('authCard').style.display = 'block';
            document.getElementById('signInButton').style.display = 'flex';

            // Hide user menu and dashboard
            const userMenu = document.getElementById('userMenu');
            userMenu.style.display = 'none';
            userMenu.classList.remove('active');
            document.getElementById('dashboard').classList.remove('show');

            showToast('Signed out from SnapIT ecosystem', 'success');
        }

        // Generate QR Code with improved error handling
        async function generateQRCode() {
            const content = document.getElementById('qrContent').value.trim();
            if (!content) {
                clearQRPreview();
                return;
            }

            // Show loading state (button might not exist during auto-generation)
            const btn = document.getElementById('saveToCloudBtn');
            if (btn) {
                btn.classList.add('loading');
            }

            try {
                const options = {
                    size: parseInt(document.getElementById('qrSize').value) || 300,
                    foregroundColor: document.getElementById('fgColor').value || '#000000',
                    backgroundColor: document.getElementById('bgColor').value || '#FFFFFF',
                    errorCorrection: 'H'
                };

                const authToken = localStorage.getItem('snapitqr_token');

                if (authToken) {
                    await generateDynamicQRCode(content, options);
                } else {
                    generateStaticQRCode(content, options);
                }

            } catch (error) {
                console.error('QR generation error:', error);
                showToast('Failed to generate QR code', 'error');
            } finally {
                if (btn) {
                    btn.classList.remove('loading');
                }
            }
        }

        // Generate static QR code using client-side library
        function generateStaticQRCode(content, options) {
            const container = document.getElementById('qrPreview');
            container.innerHTML = '';

            if (typeof QRious === 'undefined') {
                container.innerHTML = '<div class="qr-placeholder">❌ QR Code library not loaded</div>';
                showToast('QR Code library failed to load', 'error');
                return;
            }

            try {
                // Get customization options
                const borderWidth = parseInt(document.getElementById('borderWidth')?.value || 0);
                const borderColor = document.getElementById('borderColor')?.value || '#000000';
                const borderStyle = document.getElementById('borderStyle')?.value || 'solid';
                const textAbove = document.getElementById('qrTextAbove')?.value || '';
                const textBelow = document.getElementById('qrTextBelow')?.value || '';

                // Create wrapper div for QR code with border and text
                const wrapper = document.createElement('div');
                wrapper.style.display = 'inline-block';
                wrapper.style.padding = borderWidth + 'px';
                wrapper.style.border = borderWidth > 0 ? `${borderWidth}px ${borderStyle} ${borderColor}` : 'none';
                wrapper.style.backgroundColor = options.backgroundColor;
                wrapper.style.textAlign = 'center';

                // Add text above if provided
                if (textAbove) {
                    const textAboveEl = document.createElement('div');
                    textAboveEl.textContent = textAbove;
                    textAboveEl.style.marginBottom = '10px';
                    textAboveEl.style.fontWeight = '600';
                    textAboveEl.style.color = options.foregroundColor;
                    wrapper.appendChild(textAboveEl);
                }

                // Create QR code canvas
                const canvas = document.createElement('canvas');
                wrapper.appendChild(canvas);

                const qr = new QRious({
                    element: canvas,
                    value: content,
                    size: options.size,
                    background: options.backgroundColor,
                    foreground: options.foregroundColor,
                    level: 'H'
                });

                // Add text below if provided
                if (textBelow) {
                    const textBelowEl = document.createElement('div');
                    textBelowEl.textContent = textBelow;
                    textBelowEl.style.marginTop = '10px';
                    textBelowEl.style.fontWeight = '600';
                    textBelowEl.style.color = options.foregroundColor;
                    wrapper.appendChild(textBelowEl);
                }

                container.appendChild(wrapper);

                currentQR = {
                    content: content,
                    options: {
                        ...options,
                        borderWidth,
                        borderColor,
                        borderStyle,
                        textAbove,
                        textBelow
                    },
                    type: 'static',
                    timestamp: new Date().toISOString(),
                    dataURL: canvas.toDataURL()
                };

                // Auto-save static QR codes to localStorage
                const savedQR = saveStaticQRCode({
                    content: content,
                    dataURL: canvas.toDataURL(),
                    customization: {
                        size: options.size,
                        foregroundColor: options.foregroundColor,
                        backgroundColor: options.backgroundColor,
                        borderWidth,
                        borderColor,
                        borderStyle,
                        textAbove,
                        textBelow
                    }
                });

                if (savedQR) {
                    console.log('Static QR code auto-saved to localStorage:', savedQR.id);
                }

                showQRActions();
                refreshDashboard(); // Update stats to include new static QR
                showToast('QR code generated successfully!', 'success');
            } catch (error) {
                console.error('Static QR generation error:', error);
                container.innerHTML = '<div class="qr-placeholder">❌ Failed to generate QR code</div>';
                showToast('Failed to generate QR code', 'error');
            }
        }

        // Generate dynamic QR code via API
        async function generateDynamicQRCode(content, options) {
            // Use unified access key first, fallback to platform-specific token
            const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token');

            try {
                const response = await fetch('https://api.snapitqr.com/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                        'X-Platform': 'snapitqr',
                        'X-Action': 'generate-qr',
                        'X-User-ID': currentUser?.id || currentUser?.email || 'anonymous'
                    },
                    body: JSON.stringify({
                        content,
                        type: 'dynamic',
                        title: `QR Code - ${new Date().toLocaleDateString()}`,
                        options,
                        userId: currentUser?.id || currentUser?.email
                    })
                });

                if (!response.ok) {
                    if (response.status === 429 || response.status === 403) {
                        const errorData = await response.json();
                        if (errorData.upgradeRequired) {
                            showToast('You\'ve reached your limit! Redirecting to upgrade...', 'warning');
                            setTimeout(() => showUpgradeModal(), 1000);
                            return null;
                        }
                        showToast(errorData.error || 'Limit reached. Please upgrade.', 'warning');
                        return null;
                    } else if (response.status === 413) {
                        showToast('QR content too large. Please shorten your content.', 'error');
                        return null;
                    }
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.qrCode) {
                    const container = document.getElementById('qrPreview');
                    container.innerHTML = '';

                    const img = document.createElement('img');
                    img.src = result.qrCode.imageUrl || `data:image/png;base64,${result.qrCode.imageData}`;
                    img.style.maxWidth = '100%';
                    img.alt = 'Generated QR Code';
                    container.appendChild(img);

                    currentQR = {
                        ...result.qrCode,
                        options,
                        type: 'dynamic'
                    };

                    showQRActions();
                    refreshDashboard();

                    // Show success message with usage info
                    let message = 'Dynamic QR code generated and saved!';
                    if (result.usage) {
                        const remaining = result.usage.remaining;
                        const limit = result.usage.limit;
                        if (remaining !== 'unlimited') {
                            message += ` (${remaining}/${limit} QR codes remaining this month)`;
                            if (remaining < 10) {
                                setTimeout(() => {
                                    showToast('Running low on QR codes. Upgrade for unlimited generation.', 'info');
                                }, 2000);
                            }
                        }
                    }
                    showToast(message, 'success');

                    return result.qrCode;
                } else {
                    throw new Error(result.error || 'Failed to generate dynamic QR code');
                }
            } catch (error) {
                console.error('Dynamic QR generation error:', error);
                showToast('API unavailable. Generating static QR code...', 'warning');
                generateStaticQRCode(content, options);
            }
        }

        // Show QR actions
        function showQRActions() {
            document.getElementById('qrActions').classList.add('show');
            
            ['downloadBtn', 'saveBtn', 'shareBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
        }

        // Clear QR preview
        function clearQRPreview() {
            document.getElementById('qrPreview').innerHTML = '<div class="qr-placeholder">QR code will appear here</div>';
            document.getElementById('qrActions').classList.remove('show');
            
            ['downloadBtn', 'saveBtn', 'shareBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = true;
            });
        }

        // Download QR Code
        function downloadQRCode() {
            try {
                const canvas = document.querySelector('#qrPreview canvas') || 
                              document.querySelector('#qrPreview img');
                              
                if (!canvas) {
                    showToast('No QR code to download', 'error');
                    return;
                }
                
                if (canvas.tagName === 'IMG') {
                    const link = document.createElement('a');
                    link.href = canvas.src;
                    link.download = `snapit-qr-${Date.now()}.png`;
                    link.click();
                    showToast('QR code downloaded!', 'success');
                } else {
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `snapit-qr-${Date.now()}.png`;
                        link.click();
                        URL.revokeObjectURL(url);
                        showToast('QR code downloaded!', 'success');
                    }, 'image/png');
                }
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download QR code', 'error');
            }
        }

        // Save QR Code (placeholder for now)
        function saveQRCode() {
            const authToken = localStorage.getItem('snapitqr_token');
            
            if (currentQR && currentQR.type === 'dynamic') {
                showToast('Dynamic QR code already saved to your dashboard!', 'success');
                return;
            }
            
            if (currentQR && currentQR.type === 'static') {
                showToast('✅ Static QR code saved to localStorage! Create dynamic QRs to save to cloud.', 'info');
                return;
            }
            
            if (!authToken) {
                showToast('Sign in to save dynamic QR codes to your dashboard', 'info');
                return;
            }
            
            showToast('No QR code to save', 'warning');
        }

        // Share QR Code
        function shareQRCode() {
            if (navigator.share) {
                navigator.share({
                    title: 'SnapIT QR Code',
                    text: 'Check out this QR code I generated with SnapIT QR!',
                    url: window.location.href
                }).catch(console.error);
            } else {
                showToast('Sharing not supported on this device', 'warning');
            }
        }

        // Load template
        function loadTemplate(type) {
            const qrContent = document.getElementById('qrContent');
            
            const templates = {
                website: 'https://snapitqr.com',
                email: 'mailto:contact@snapitqr.com?subject=Hello&body=Hi there!',
                phone: 'tel:+1234567890',
                wifi: 'WIFI:T:WPA;S:MyNetwork;P:password123;H:false;;',
                text: 'Hello from SnapIT QR! 🚀'
            };
            
            qrContent.value = templates[type] || 'https://snapitqr.com';
            generateQRCode();
            showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} template loaded!`, 'success');
        }

        // Shorten URL with SnapIT URL integration via QR API proxy
        async function shortenURL() {
            const url = document.getElementById('urlToShorten').value.trim();
            const customAlias = document.getElementById('customAlias').value.trim();
            const selectedDomain = document.getElementById('domainSelect').value;
            
            if (!url) {
                showToast('Please enter a URL to shorten', 'error');
                return;
            }

            // Check usage limits for authenticated users
            if (currentUser && window.userStats) {
                if (window.userStats.tier === 'free' && window.userStats.urlUsed >= window.userStats.urlLimit) {
                    showToast(`You've reached your limit of ${window.userStats.urlLimit} short URLs! Upgrade for more.`, 'warning');
                    setTimeout(() => showUpgradeModal(), 1000);
                    return;
                }
            }

            // Basic URL validation
            try {
                new URL(url);
            } catch (e) {
                showToast('Please enter a valid URL (include https://)', 'error');
                return;
            }

            const btn = document.getElementById('shortenBtn');
            btn.classList.add('loading');

            // Check authentication first
            if (!currentUser) {
                showToast('Please sign in to create short URLs', 'error');
                btn.classList.remove('loading');
                return;
            }

            try {
                const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token');

                if (!authToken) {
                    showToast('Please sign in to create short URLs', 'error');
                    btn.classList.remove('loading');
                    return;
                }

                const requestData = {
                    url: url,
                    domain: selectedDomain,
                    action: 'shorten'
                };

                if (customAlias) {
                    // Basic validation for custom alias
                    if (!/^[a-zA-Z0-9-_]+$/.test(customAlias)) {
                        throw new Error('Custom alias can only contain letters, numbers, hyphens, and underscores');
                    }
                    requestData.customAlias = customAlias;
                }

                // Add expiration date if provided
                const expirationDate = document.getElementById('expirationDate').value;
                if (expirationDate) {
                    // Convert to ISO string for API
                    const expirationTimestamp = new Date(expirationDate).toISOString();
                    requestData.expiresAt = expirationTimestamp;
                }

                // Use our deployed API endpoint
                let response;
                try {
                    // Update request data to match our API with authenticated user
                    const apiRequestData = {
                        url: url,
                        userId: currentUser.id || currentUser.sub || currentUser.email
                    };

                    if (customAlias) {
                        apiRequestData.customAlias = customAlias;
                    }

                    if (requestData.expiresAt) {
                        apiRequestData.expiresAt = requestData.expiresAt;
                    }

                    // Use appropriate API based on selected domain
                    const apiEndpoint = 'https://api.snapitqr.com/url/shorten';

                    response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(apiRequestData)
                    });
                } catch (fetchError) {
                    console.error('API fetch error:', fetchError);
                    throw new Error('Failed to connect to API. Please try again.');
                }

                const result = await response.json();

                if (result.success) {
                    // Normalize response format between different APIs
                    const normalizedResult = {
                        success: true,
                        shortUrl: result.shortUrl || result.url,
                        shortCode: result.shortCode || result.code,
                        originalUrl: result.originalUrl || result.targetUrl || url
                    };

                    displayURLResult(normalizedResult);
                    showToast('URL shortened successfully!', 'success');

                    // Refresh dashboard to show the new URL
                    await refreshDashboard();
                } else {
                    throw new Error(result.error || 'Failed to shorten URL');
                }
            } catch (error) {
                console.error('URL shortening error:', error);
                showToast(`Failed to shorten URL: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
            }
        }

        // Display URL shortening result
        function displayURLResult(data) {
            const resultsContainer = document.getElementById('urlResults');
            const shortUrl = data.shortUrl || data.url;
            const displayUrl = shortUrl || 'Error creating URL';
            
            resultsContainer.innerHTML = `
                <div class="url-result">
                    <h4>✅ Short URL Created!</h4>
                    <div class="shortened-url">
                        <span class="shortened-url-text">${displayUrl}</span>
                        <button class="btn btn-secondary" onclick="copyToClipboard('${displayUrl}')" style="padding: 0.5rem 1rem;">
                            📋 Copy
                        </button>
                    </div>
                    <div style="display: flex; gap: var(--space-2); justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="createQRFromURL('${displayUrl}')" style="padding: 0.5rem 1rem;">
                            📱 Create QR Code
                        </button>
                        <button class="btn btn-secondary" onclick="window.open('${displayUrl}', '_blank')" style="padding: 0.5rem 1rem;">
                            🔗 Test Link
                        </button>
                    </div>
                </div>
            `;
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        // Create QR code from URL
        function createQRFromURL(url) {
            document.getElementById('qrContent').value = url;
            generateQRCode();
            showToast('QR code generated for short URL!', 'success');
        }

        // Dashboard functions
        // Static QR Code Storage Management
        const QR_STORAGE_KEY = 'snapitqr_static_qrs';
        const URL_STORAGE_KEY = 'snapitqr_static_urls';

        function getStaticQRCodes() {
            try {
                return JSON.parse(localStorage.getItem(QR_STORAGE_KEY) || '[]');
            } catch (error) {
                console.error('Error loading static QR codes:', error);
                return [];
            }
        }

        function saveStaticQRCode(qrData) {
            try {
                const qrs = getStaticQRCodes();
                const newQR = {
                    id: Date.now().toString(),
                    content: qrData.content,
                    dataURL: qrData.dataURL,
                    customization: qrData.customization || {},
                    createdAt: new Date().toISOString(),
                    type: 'static'
                };
                qrs.unshift(newQR); // Add to beginning
                
                // Keep only last 100 static QRs
                if (qrs.length > 100) qrs.splice(100);
                
                localStorage.setItem(QR_STORAGE_KEY, JSON.stringify(qrs));
                return newQR;
            } catch (error) {
                console.error('Error saving static QR code:', error);
                return null;
            }
        }

        function deleteStaticQRCode(qrId) {
            try {
                const qrs = getStaticQRCodes();
                const filtered = qrs.filter(qr => qr.id !== qrId);
                localStorage.setItem(QR_STORAGE_KEY, JSON.stringify(filtered));
                return true;
            } catch (error) {
                console.error('Error deleting static QR code:', error);
                return false;
            }
        }

        // Switch between dashboard tabs
        function switchDashboardTab(tab) {
            const qrTab = document.getElementById('qrTab');
            const urlsTab = document.getElementById('urlsTab');
            const qrList = document.getElementById('qrCodesList');
            const urlsList = document.getElementById('shortUrlsList');

            if (tab === 'qr') {
                qrTab.style.borderBottom = '3px solid var(--primary)';
                qrTab.style.color = 'var(--primary)';
                qrTab.style.fontWeight = '600';
                urlsTab.style.borderBottom = '3px solid transparent';
                urlsTab.style.color = 'var(--gray-600)';
                urlsTab.style.fontWeight = '500';
                qrList.style.display = 'block';
                urlsList.style.display = 'none';
            } else {
                urlsTab.style.borderBottom = '3px solid var(--primary)';
                urlsTab.style.color = 'var(--primary)';
                urlsTab.style.fontWeight = '600';
                qrTab.style.borderBottom = '3px solid transparent';
                qrTab.style.color = 'var(--gray-600)';
                qrTab.style.fontWeight = '500';
                qrList.style.display = 'none';
                urlsList.style.display = 'block';
            }
        }

        async function refreshDashboard() {
            // Use unified access key first, fallback to platform-specific token
            const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token') || localStorage.getItem('snapiturl_token');
            staticQRs = getStaticQRCodes();
            dynamicQRs = [];
            shortUrls = [];  // Fixed: removed 'let' to use global variable
            window.userStats = { tier: 'free', qrUsed: 0, urlUsed: 0, qrLimit: 1, urlLimit: 3 };

            // Get dynamic data if authenticated
            if (authToken) {
                try {
                    // Get dashboard data
                    const dashboardResponse = await fetch('https://api.snapitqr.com/dashboard-data', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (dashboardResponse.ok) {
                        const dashboardData = await dashboardResponse.json();
                        // Fixed: Merge subscription data instead of replacing entire object
                        window.userStats = {
                            tier: dashboardData.data?.user?.subscription?.tier || 'free',
                            qrUsed: dashboardData.data?.user?.subscription?.qrUsed || 0,
                            urlUsed: dashboardData.data?.user?.subscription?.urlUsed || 0,
                            qrLimit: dashboardData.data?.user?.subscription?.qrLimit || 1,
                            urlLimit: dashboardData.data?.user?.subscription?.urlLimit || 3
                        };

                        // Update user plan display
                        document.getElementById('currentPlan').textContent =
                            window.userStats.tier.charAt(0).toUpperCase() + window.userStats.tier.slice(1);
                    }

                    // Get QR codes
                    const qrResponse = await fetch('https://api.snapitqr.com/qr-codes', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (qrResponse.ok) {
                        const qrData = await qrResponse.json();
                        dynamicQRs = qrData.qrCodes || qrData.data?.qrCodes || [];
                    }

                    // Get short URLs from snapiturl API
                    const urlResponse = await fetch('https://api.snapitqr.com/short-urls', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (urlResponse.ok) {
                        const urlData = await urlResponse.json();
                        shortUrls = urlData.shortUrls || urlData.data?.shortUrls || [];
                    }
                    
                } catch (error) {
                    console.error('Dashboard API error:', error);
                    // Still show static data
                }
            }
            
            // Calculate totals
            const totalQRs = staticQRs.length + dynamicQRs.length;
            const totalScans = dynamicQRs.reduce((sum, qr) => sum + (qr.scans || 0), 0);
            const totalURLs = shortUrls.length;
            const totalClicks = shortUrls.reduce((sum, url) => sum + (url.clicks || 0), 0);

            // Update dashboard stats
            document.getElementById('qrCount').textContent = totalQRs;
            document.getElementById('urlCount').textContent = totalURLs;
            document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
            document.getElementById('currentPlan').textContent =
                window.userStats.tier.charAt(0).toUpperCase() + window.userStats.tier.slice(1);

            // Display QR codes list
            displayQRCodesList();

            // Display short URLs list
            displayShortURLsList();

            // Show usage limits for authenticated users
            if (authToken) {
                const qrUsage = `${window.userStats.qrUsed}/${window.userStats.qrLimit}`;
                const urlUsage = `${window.userStats.urlUsed}/${window.userStats.urlLimit}`;
                showToast(`Usage: ${qrUsage} Dynamic QRs, ${urlUsage} Short URLs`, 'info');
            }
        }

        // Display QR codes list
        function displayQRCodesList() {
            const container = document.getElementById('qrCodesContainer');
            const allQRs = [...dynamicQRs.map(qr => ({ ...qr, type: 'dynamic' })),
                            ...staticQRs.map(qr => ({ ...qr, type: 'static' }))];

            if (allQRs.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--gray-500); text-align: center; padding: var(--space-8);">
                        No QR codes yet. Create your first QR code above! 👆
                    </p>
                `;
                return;
            }

            container.innerHTML = allQRs.map(qr => `
                <div class="glass-card" style="margin-bottom: var(--space-4); padding: var(--space-4);">
                    <div style="display: flex; gap: var(--space-4); align-items: start;">
                        <div style="flex-shrink: 0;">
                            <img src="${qr.qrUrl || qr.qrCodeUrl || qr.url}" alt="QR Code"
                                 style="width: 100px; height: 100px; border-radius: 8px; border: 2px solid var(--gray-200);">
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <span style="font-weight: 600; color: var(--gray-800); font-size: 1rem;">
                                    ${qr.name || 'QR Code'}
                                </span>
                                <span class="badge ${qr.type === 'dynamic' ? 'badge-success' : 'badge-secondary'}"
                                      style="font-size: 0.75rem; padding: 2px 8px; border-radius: 12px;">
                                    ${qr.type === 'dynamic' ? '🔄 Dynamic' : '📄 Static'}
                                </span>
                            </div>
                            <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: var(--space-2); word-break: break-all;">
                                ${qr.destinationUrl || qr.content || 'No content'}
                            </p>
                            <div style="display: flex; gap: var(--space-4); font-size: 0.875rem; color: var(--gray-500);">
                                ${qr.type === 'dynamic' ? `<span>📊 ${qr.scans || 0} scans</span>` : ''}
                                <span>📅 ${qr.createdAt ? new Date(qr.createdAt).toLocaleDateString() : 'Today'}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-2); flex-shrink: 0; flex-wrap: wrap;">
                            ${qr.type === 'dynamic' ? `
                                <button class="btn btn-secondary" onclick="editQRCode('${qr.qrId}')"
                                        style="padding: 8px 12px; font-size: 0.875rem;">
                                    ✏️ Edit Destination
                                </button>
                            ` : `
                                <button class="btn btn-secondary" onclick="upgradeToDynamic('${qr.id}', '${escapeHtml(qr.content || '')}')"
                                        style="padding: 8px 12px; font-size: 0.875rem;">
                                    🔄 Make Editable
                                </button>
                            `}
                            <button class="btn btn-primary" onclick="showQRCustomizationEditor('${qr.qrId || qr.id}', '${qr.type}')"
                                    style="padding: 8px 12px; font-size: 0.875rem; background: linear-gradient(135deg, var(--primary) 0%, #ec4899 100%);">
                                🎨 Customize
                            </button>
                            <button class="btn btn-secondary" onclick="downloadQRFromList('${qr.qrId || qr.id}', '${qr.type}', '${qr.name || 'qr-code'}')"
                                    style="padding: 8px 12px; font-size: 0.875rem;">
                                💾 Download
                            </button>
                            <button class="btn btn-danger" onclick="deleteQRCode('${qr.qrId || qr.id}', '${qr.type}')"
                                    style="padding: 8px 12px; font-size: 0.875rem; background: var(--error); color: white;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Helper function to escape HTML for safe string interpolation
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Upgrade static QR code to dynamic (requires sign-in)
        async function upgradeToDynamic(qrId, content) {
            // Check if user is signed in
            if (!currentUser) {
                // Show sign-in modal with explanation
                const shouldSignIn = await showConfirmModal(
                    '✨ Make This QR Code Editable!<br><br>' +
                    'To edit the destination URL of your QR code, you need to sign in.<br><br>' +
                    'With a dynamic QR code, you can:<br>' +
                    '• Change where it points anytime<br>' +
                    '• Track scans and analytics<br>' +
                    '• Keep the same QR image\n\n' +
                    'Sign in now to upgrade this QR code?'
                );

                if (shouldSignIn) {
                    // Show auth card
                    document.getElementById('authCard').style.display = 'block';
                    document.getElementById('authCard').scrollIntoView({ behavior: 'smooth' });
                    showToast('Please sign in to make your QR code editable', 'info');

                    // Store pending upgrade in localStorage
                    localStorage.setItem('pendingQRUpgrade', JSON.stringify({ qrId, content }));
                }
                return;
            }

            // User is signed in - create dynamic QR code
            try {
                showToast('Converting to dynamic QR code...', 'info');

                const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token');
                const response = await fetch('https://api.snapitqr.com/qr-codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        destinationUrl: content,
                        isDynamic: true,
                        name: 'Dynamic QR Code'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('✨ QR code is now dynamic! You can edit the destination anytime.', 'success');

                    // Remove from static QR codes in localStorage
                    const staticQRs = JSON.parse(localStorage.getItem('static_qr_codes') || '[]');
                    const updated = staticQRs.filter(qr => qr.id !== qrId);
                    localStorage.setItem('static_qr_codes', JSON.stringify(updated));

                    // Refresh dashboard to show the new dynamic QR
                    await refreshDashboard();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to create dynamic QR code', 'error');
                }
            } catch (error) {
                console.error('Upgrade to dynamic error:', error);
                showToast('Failed to convert to dynamic QR code', 'error');
            }
        }

        // Download QR code from list
        async function downloadQRFromList(qrId, qrType, name) {
            try {
                // Find the QR code
                const qr = qrType === 'dynamic'
                    ? dynamicQRs.find(q => q.qrId === qrId)
                    : staticQRs.find(q => q.id === qrId);

                if (!qr) {
                    showToast('QR code not found', 'error');
                    return;
                }

                // Get customization settings
                const customization = qr.customization || {};
                const fgColor = customization.foregroundColor || '#000000';
                const bgColor = customization.backgroundColor || '#FFFFFF';
                const borderWidth = customization.borderWidth || 0;
                const borderColor = customization.borderColor || '#000000';
                const borderStyle = customization.borderStyle || 'solid';
                const textAbove = customization.textAbove || '';
                const textBelow = customization.textBelow || '';
                const size = customization.size || 300;

                // Create offscreen canvas to render the complete QR code with customizations
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Calculate dimensions for text
                ctx.font = 'bold 16px Arial';
                const textAboveHeight = textAbove ? 30 : 0;
                const textBelowHeight = textBelow ? 30 : 0;
                const totalBorderWidth = borderWidth * 2;

                // Set canvas size to include border and text
                canvas.width = size + totalBorderWidth;
                canvas.height = size + totalBorderWidth + textAboveHeight + textBelowHeight;

                // Fill background with border color first
                ctx.fillStyle = borderColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Fill inner area with background color
                ctx.fillStyle = bgColor;
                ctx.fillRect(borderWidth, borderWidth, canvas.width - totalBorderWidth, canvas.height - totalBorderWidth);

                // Draw text above if provided
                if (textAbove) {
                    ctx.fillStyle = fgColor;
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(textAbove, canvas.width / 2, borderWidth + textAboveHeight / 2);
                }

                // Generate QR code on temporary canvas
                const qrCanvas = document.createElement('canvas');
                const qrious = new QRious({
                    element: qrCanvas,
                    value: qr.content || qr.destinationUrl || qr.url || '',
                    size: size,
                    background: bgColor,
                    foreground: fgColor,
                    level: 'H'
                });

                // Draw QR code onto main canvas
                ctx.drawImage(qrCanvas, borderWidth, borderWidth + textAboveHeight);

                // Draw text below if provided
                if (textBelow) {
                    ctx.fillStyle = fgColor;
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(textBelow, canvas.width / 2, borderWidth + textAboveHeight + size + textBelowHeight / 2);
                }

                // Draw border if style is not solid (solid is already drawn with background)
                if (borderWidth > 0 && borderStyle !== 'solid') {
                    ctx.strokeStyle = borderColor;
                    ctx.lineWidth = borderWidth;

                    if (borderStyle === 'dashed') {
                        ctx.setLineDash([10, 5]);
                    } else if (borderStyle === 'dotted') {
                        ctx.setLineDash([2, 3]);
                    } else if (borderStyle === 'double') {
                        // Draw double border
                        ctx.lineWidth = borderWidth / 3;
                        ctx.strokeRect(borderWidth / 3, borderWidth / 3, canvas.width - borderWidth / 1.5, canvas.height - borderWidth / 1.5);
                        ctx.strokeRect(borderWidth - borderWidth / 3, borderWidth - borderWidth / 3, canvas.width - totalBorderWidth + borderWidth / 1.5, canvas.height - totalBorderWidth + borderWidth / 1.5);
                    }

                    if (borderStyle !== 'double') {
                        ctx.strokeRect(borderWidth / 2, borderWidth / 2, canvas.width - borderWidth, canvas.height - borderWidth);
                    }
                }

                // Download the canvas
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${name || 'snapit-qr'}-${Date.now()}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                    showToast('QR code with customizations downloaded!', 'success');
                }, 'image/png');

            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download QR code', 'error');
            }
        }

        // Edit dynamic QR code
        async function editQRCode(qrId) {
            const qr = dynamicQRs.find(q => q.qrId === qrId);
            if (!qr) {
                showToast('QR code not found', 'error');
                return;
            }

            const newUrl = await showPromptModal('Enter the new destination URL where this QR code should redirect:', qr.content || qr.destinationUrl, 'Edit QR Code Destination');
            if (!newUrl || newUrl === (qr.content || qr.destinationUrl)) return;

            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`https://api.snapitqr.com/qr-codes/${qrId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ content: newUrl })
                });

                if (response.ok) {
                    showToast('QR code destination updated successfully!', 'success');
                    await refreshDashboard();
                } else {
                    const error = await response.json();
                    showToast(error.message || 'Failed to update QR code', 'error');
                }
            } catch (error) {
                console.error('Edit QR error:', error);
                showToast('Failed to update QR code', 'error');
            }
        }

        // Delete QR code
        async function deleteQRCode(qrId, type) {
            const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token') || localStorage.getItem('snapiturl_token');

            // Confirm deletion
            if (!confirm('Are you sure you want to delete this QR code? This action cannot be undone.')) {
                return;
            }

            try {
                if (type === 'static') {
                    // Delete from localStorage
                    const staticQRs = getStaticQRCodes();
                    const updatedQRs = staticQRs.filter(qr => qr.id !== qrId);
                    localStorage.setItem('snapitqr_static_qrs', JSON.stringify(updatedQRs));
                    showToast('✅ QR code deleted from your device!', 'success');
                    refreshDashboard();
                } else {
                    // Delete dynamic QR from API
                    if (!authToken) {
                        showToast('Please sign in to delete cloud QR codes', 'error');
                        return;
                    }

                    const response = await fetch(`https://api.snapitqr.com/qr-codes/${qrId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        showToast('✅ QR code deleted successfully!', 'success');
                        refreshDashboard();
                    } else {
                        const error = await response.json();
                        showToast(error.message || 'Failed to delete QR code', 'error');
                    }
                }
            } catch (error) {
                console.error('Delete QR error:', error);
                showToast('Failed to delete QR code', 'error');
            }
        }

        // Display Short URLs list
        function displayShortURLsList() {
            const container = document.getElementById('shortUrlsContainer');

            if (shortUrls.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--gray-500); text-align: center; padding: var(--space-8);">
                        No short links yet. Create your first short link above! 👆
                    </p>
                `;
                return;
            }

            container.innerHTML = shortUrls.map(url => {
                const domain = url.shortUrl?.includes('snapiturl.com') ? 'snapiturl.com' : 'snapitqr.com';
                const shortCode = url.shortCode || url.shortUrl?.split('/').pop() || '';
                const fullShortUrl = url.shortUrl || `https://${domain}/${shortCode}`;
                const expiresText = url.expiresAt ? new Date(url.expiresAt).toLocaleDateString() : 'Never';
                const clicks = url.clicks || 0;
                const createdDate = url.createdAt ? new Date(url.createdAt).toLocaleDateString() : 'Today';

                return `
                <div class="glass-card" style="margin-bottom: var(--space-4); padding: var(--space-4);">
                    <div style="display: flex; gap: var(--space-4); align-items: start; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <span style="font-weight: 600; color: var(--gray-800); font-size: 1rem;">
                                    ${url.title || 'Short Link'}
                                </span>
                                <span class="badge badge-primary" style="font-size: 0.75rem; padding: 2px 8px; border-radius: 12px;">
                                    ${domain}
                                </span>
                            </div>

                            <div style="margin-bottom: var(--space-3);">
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                    <span style="color: var(--gray-500); font-size: 0.875rem;">🔗 Short URL:</span>
                                    <a href="${fullShortUrl}" target="_blank"
                                       style="color: var(--primary-600); font-weight: 500; text-decoration: none; word-break: break-all;">
                                        ${fullShortUrl}
                                    </a>
                                    <button onclick="copyToClipboard('${fullShortUrl}')"
                                            style="padding: 4px 8px; font-size: 0.75rem; background: var(--gray-100); border: 1px solid var(--gray-300); border-radius: 4px; cursor: pointer;"
                                            title="Copy to clipboard">
                                        📋
                                    </button>
                                </div>
                                <div style="color: var(--gray-600); font-size: 0.875rem; word-break: break-all;">
                                    <span style="color: var(--gray-500);">→</span> ${url.originalUrl || url.targetUrl || 'No destination'}
                                </div>
                            </div>

                            <div style="display: flex; gap: var(--space-4); flex-wrap: wrap; font-size: 0.875rem; color: var(--gray-500);">
                                <span>📊 ${clicks} clicks</span>
                                <span>📅 Created: ${createdDate}</span>
                                <span>⏰ Expires: ${expiresText}</span>
                                ${url.status ? `<span class="badge ${url.status === 'active' ? 'badge-success' : 'badge-secondary'}" style="font-size: 0.75rem;">
                                    ${url.status}
                                </span>` : ''}
                            </div>
                        </div>

                        <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="viewAnalytics('${shortCode}')"
                                    style="padding: 8px 16px; font-size: 0.875rem; white-space: nowrap;">
                                📈 View Analytics
                            </button>
                            <button class="btn btn-secondary" onclick="editShortURL('${shortCode}')"
                                    style="padding: 8px 16px; font-size: 0.875rem;">
                                ✏️ Edit
                            </button>
                            <button class="btn btn-secondary" onclick="deleteShortURL('${url.linkId || shortCode}', '${shortCode}')"
                                    style="padding: 8px 16px; font-size: 0.875rem; background: var(--red-50); color: var(--red-600);">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy', 'error');
            });
        }

        // View analytics for short URL
        async function viewAnalytics(shortCode) {
            showToast('Loading analytics...', 'info');

            try {
                const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token');
                const response = await fetch(`https://api.snapitqr.com/analytics/url/${shortCode}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAnalyticsModal(data, shortCode);
                } else {
                    showToast('Failed to load analytics', 'error');
                }
            } catch (error) {
                console.error('Analytics error:', error);
                showToast('Failed to load analytics', 'error');
            }
        }

        // Display analytics modal
        function displayAnalyticsModal(data, shortCode) {
            const modalHtml = `
                <div id="analyticsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;">
                    <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800);">📈 Analytics for /${shortCode}</h2>
                            <button onclick="closeAnalyticsModal()" style="padding: 8px 16px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer; font-size: 1.25rem;">×</button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="background: var(--blue-50); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--blue-600);">${data.totalClicks || 0}</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Total Clicks</div>
                            </div>
                            <div style="background: var(--green-50); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--green-600);">${data.uniqueVisitors || 0}</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Unique Visitors</div>
                            </div>
                            <div style="background: var(--purple-50); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--purple-600);">${data.clicksToday || 0}</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Today</div>
                            </div>
                            <div style="background: var(--orange-50); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--orange-600);">${data.clicksThisWeek || 0}</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">This Week</div>
                            </div>
                        </div>

                        <div id="analyticsChart" style="margin-top: 24px; height: 300px; background: var(--gray-50); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500);">
                            📊 Chart will display here
                        </div>

                        ${data.recentClicks && data.recentClicks.length > 0 ? `
                        <div style="margin-top: 24px;">
                            <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 12px; color: var(--gray-800);">Recent Clicks</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${data.recentClicks.slice(0, 10).map(click => `
                                    <div style="padding: 8px; border-bottom: 1px solid var(--gray-200); font-size: 0.875rem;">
                                        <span style="color: var(--gray-600);">${new Date(click.timestamp).toLocaleString()}</span>
                                        ${click.country ? `<span style="margin-left: 12px;">🌍 ${click.country}</span>` : ''}
                                        ${click.referer && click.referer !== 'Direct' ? `<span style="margin-left: 12px;">🔗 ${click.referer}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeAnalyticsModal() {
            const modal = document.getElementById('analyticsModal');
            if (modal) modal.remove();
        }

        // Edit short URL
        async function editShortURL(shortCode) {
            const url = shortUrls.find(u => u.shortCode === shortCode);
            if (!url) {
                showToast('URL not found', 'error');
                return;
            }

            const newDestination = await showPromptModal('Enter the new destination URL where this short link should redirect:', url.originalUrl || url.targetUrl, 'Edit Short Link Destination');
            if (!newDestination || newDestination === (url.originalUrl || url.targetUrl)) return;

            try {
                const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token');
                const response = await fetch(`https://api.snapitqr.com/short-urls/${shortCode}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ originalUrl: newDestination })
                });

                if (response.ok) {
                    showToast('Short URL updated successfully!', 'success');
                    await refreshDashboard();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to update URL', 'error');
                }
            } catch (error) {
                console.error('Edit URL error:', error);
                showToast('Failed to update URL', 'error');
            }
        }

        // Delete short URL
        async function deleteShortURL(linkId, shortCode) {
            const confirmed = await showConfirmModal('Are you sure you want to delete this short link? This action cannot be undone.', 'Delete Short Link');
            if (!confirmed) {
                return;
            }

            try {
                const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapitqr_token');
                // Use linkId if available, otherwise fall back to shortCode
                const identifier = linkId || shortCode;
                const response = await fetch(`https://api.snapiturl.com/short-urls/${identifier}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    showToast('Short URL deleted successfully!', 'success');
                    await refreshDashboard();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to delete URL', 'error');
                }
            } catch (error) {
                console.error('Delete URL error:', error);
                showToast('Failed to delete URL', 'error');
            }
        }

        // Stripe Configuration - LIVE MODE
        const STRIPE_CONFIG = {
            publishableKey: window.SNAPIT_CONFIG?.STRIPE_PUBLISHABLE_KEY || 'pk_live_51RZK4aRE8RY21XQRpweG5ctPcGaRzShfajNWraIKOCLg4vYpqS88EqhpTGfj2joQbTjRK3spfP6uA6pGp2F4vRD700dBUbZ4aV',
            plans: window.SNAPIT_CONFIG?.STRIPE_PLANS || {
                core: {
                    monthlyPriceId: 'price_1SJIkjRE8RY21XQR852sQslC',
                    yearlyPriceId: 'price_1SJIklRE8RY21XQR9dUaWf7i',
                    monthlyAmount: '$19',
                    yearlyAmount: '$152',
                    name: 'Core'
                },
                growth: {
                    monthlyPriceId: 'price_1SJIkoRE8RY21XQRZ8WiodpU',
                    yearlyPriceId: 'price_1SJIkqRE8RY21XQRCwQ4M4g6',
                    monthlyAmount: '$69',
                    yearlyAmount: '$552',
                    name: 'Growth'
                },
                business: {
                    monthlyPriceId: 'price_1SJIksRE8RY21XQRsdtzN7cr',
                    yearlyPriceId: 'price_1SJIkuRE8RY21XQRJxvyf4x5',
                    monthlyAmount: '$199',
                    yearlyAmount: '$1,592',
                    name: 'Business'
                }
            }
        };

        // Stripe initialization disabled to prevent errors
        let stripe = null;
        // if (window.Stripe) {
        //     stripe = Stripe(STRIPE_CONFIG.publishableKey);
        // }

        // Show upgrade modal with pricing
        function showUpgradeModal() {
            const modal = document.createElement('div');
            modal.className = 'upgrade-modal';
            modal.innerHTML = `
                <div class="upgrade-modal-content">
                    <div class="upgrade-header">
                        <h2>🚀 Upgrade Your Plan</h2>
                        <button class="close-btn" onclick="this.closest('.upgrade-modal').remove()">×</button>
                    </div>
                    
                    <div class="billing-toggle" style="text-align: center; margin-bottom: 2rem;">
                        <button class="billing-btn active" data-period="monthly">Monthly</button>
                        <button class="billing-btn" data-period="yearly">Yearly <span style="color: #10b981;">(Save 20%)</span></button>
                    </div>

                    <div class="pricing-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; overflow-x: auto;">
                        <div class="pricing-card">
                            <h3>FREE</h3>
                            <div class="price">$0<span>/forever</span></div>
                            <ul>
                                <li>✅ 20 Dynamic QR Codes</li>
                                <li>✅ 50 Short URLs</li>
                                <li>✅ 100 Form Responses/month</li>
                                <li>✅ Unlimited Static QR Codes</li>
                                <li>✅ Basic Analytics</li>
                                <li>✅ Custom Design & Logo</li>
                            </ul>
                            <button class="btn btn-secondary" disabled>Current Plan</button>
                        </div>

                        <div class="pricing-card">
                            <h3>Starter</h3>
                            <div class="price" data-monthly="$3.99" data-yearly="$39.99">$3.99<span class="period">/month</span></div>
                            <ul>
                                <li>✅ 500 Dynamic QR Codes/month</li>
                                <li>✅ 1,000 Short URLs</li>
                                <li>✅ 1,000 Form Responses</li>
                                <li>✅ Advanced Customization</li>
                                <li>✅ Real-time Analytics</li>
                                <li>✅ CSV Export</li>
                            </ul>
                            <button class="btn btn-primary" onclick="upgradeToplan('starter')">Choose Starter</button>
                        </div>

                        <div class="pricing-card popular">
                            <div class="popular-badge">Most Popular</div>
                            <h3>Professional</h3>
                            <div class="price" data-monthly="$9.99" data-yearly="$99.99">$9.99<span class="period">/month</span></div>
                            <ul>
                                <li>✅ 2,500 Dynamic QR Codes/month</li>
                                <li>✅ 5,000 Short URLs</li>
                                <li>✅ 5,000 Form Responses</li>
                                <li>✅ Full Branding Control</li>
                                <li>✅ Advanced Analytics</li>
                                <li>✅ API Access (Basic)</li>
                            </ul>
                            <button class="btn btn-primary" onclick="upgradeToplan('professional')">Choose Professional</button>
                        </div>

                        <div class="pricing-card">
                            <h3>Business</h3>
                            <div class="price" data-monthly="$29.99" data-yearly="$299.99">$29.99<span class="period">/month</span></div>
                            <ul>
                                <li>✅ 10,000 Dynamic QR Codes/month</li>
                                <li>✅ 25,000 Short URLs</li>
                                <li>✅ 25,000 Form Responses</li>
                                <li>✅ Team Collaboration (15 users)</li>
                                <li>✅ Custom Integrations</li>
                                <li>✅ Priority Support</li>
                            </ul>
                            <button class="btn btn-primary" onclick="upgradeToplan('business')">Choose Business</button>
                        </div>

                        <div class="pricing-card">
                            <h3>Premium</h3>
                            <div class="price" data-monthly="$49.99" data-yearly="$499.99">$49.99<span class="period">/month</span></div>
                            <ul>
                                <li>✅ 50,000 Dynamic QR Codes/month</li>
                                <li>✅ 100,000 Short URLs</li>
                                <li>✅ 100,000 Form Responses</li>
                                <li>✅ Advanced Team Features (50 users)</li>
                                <li>✅ 10 Custom Domains</li>
                                <li>✅ Dedicated Account Manager</li>
                            </ul>
                            <button class="btn btn-primary" onclick="upgradeToplan('premium')">Choose Premium</button>
                        </div>

                        <div class="pricing-card">
                            <h3>Enterprise</h3>
                            <div class="price" data-monthly="$99.99" data-yearly="$999.99">$99.99<span class="period">/month</span></div>
                            <ul>
                                <li>✅ Unlimited Dynamic QR Codes</li>
                                <li>✅ Unlimited Short URLs</li>
                                <li>✅ Unlimited Form Responses</li>
                                <li>✅ Unlimited Team Members</li>
                                <li>✅ Unlimited Custom Domains</li>
                                <li>✅ White-glove Onboarding</li>
                                <li>✅ 24/7 Dedicated Support</li>
                            </ul>
                            <button class="btn btn-primary" onclick="upgradeToplan('enterprise')">Choose Enterprise</button>
                        </div>
                    </div>

                </div>
            `;

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 100);

            // Billing period toggle - add event listeners after modal is added to DOM
            modal.querySelectorAll('.billing-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.querySelectorAll('.billing-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const period = this.dataset.period;
                    modal.querySelectorAll('.price').forEach(priceEl => {
                        const monthly = priceEl.dataset.monthly;
                        const yearly = priceEl.dataset.yearly;
                        if (monthly && yearly) {
                            priceEl.innerHTML = (period === 'monthly' ? monthly : yearly) +
                                '<span class="period">/' + (period === 'monthly' ? 'month' : 'year') + '</span>';
                        }
                    });
                });
            });
        }

        // Upgrade to specific plan
        async function upgradeToplan(planKey) {
            if (!currentUser) {
                showToast('Please sign in to upgrade your plan', 'error');
                return;
            }

            const plan = STRIPE_CONFIG.plans[planKey];
            if (!plan) {
                showToast('Invalid plan selected', 'error');
                return;
            }

            try {
                // Initialize Stripe if not already done
                if (!window.stripe) {
                    window.stripe = Stripe(STRIPE_CONFIG.publishableKey);
                }

                // Determine billing period (monthly or yearly)
                const billingPeriod = document.querySelector('.billing-btn.active')?.dataset.period || 'monthly';
                const priceId = billingPeriod === 'monthly' ? plan.monthlyPriceId : plan.yearlyPriceId;
                const amount = billingPeriod === 'monthly' ? plan.monthlyAmount : plan.yearlyAmount;

                showToast(`Redirecting to payment for ${plan.name} plan (${amount}/${billingPeriod})...`, 'info');

                // Call backend to create checkout session
                const response = await fetch('https://api.snapitqr.com/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: priceId,
                        userId: currentUser.sub || currentUser.id,
                        planName: plan.name,
                        billingPeriod: billingPeriod
                    })
                });

                const session = await response.json();

                if (session.sessionId) {
                    // Redirect to Stripe Checkout
                    const result = await window.stripe.redirectToCheckout({
                        sessionId: session.sessionId
                    });

                    if (result.error) {
                        showToast(`Payment error: ${result.error.message}`, 'error');
                    }
                } else {
                    throw new Error(session.error || 'Failed to create checkout session');
                }
            } catch (error) {
                console.error('Upgrade error:', error);
                showToast(`Upgrade failed: ${error.message}`, 'error');
            }
        }

        // Custom Confirm Modal
        function showConfirmModal(message, title = 'Confirm Action') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 450px; width: 100%; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);">
                        <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--gray-800); margin: 0 0 16px 0;">${title}</h3>
                        <p style="color: var(--gray-600); margin-bottom: 24px; line-height: 1.5;">${message}</p>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button id="cancelBtn" class="btn btn-secondary" style="padding: 10px 20px;">Cancel</button>
                            <button id="confirmBtn" class="btn btn-primary" style="padding: 10px 20px; background: var(--error); border-color: var(--error);">Confirm</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('#confirmBtn').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                modal.querySelector('#cancelBtn').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };
            });
        }

        // Custom Prompt Modal
        function showPromptModal(message, defaultValue = '', title = 'Enter Value') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 500px; width: 100%; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);">
                        <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--gray-800); margin: 0 0 16px 0;">${title}</h3>
                        <p style="color: var(--gray-600); margin-bottom: 16px; line-height: 1.5;">${message}</p>
                        <input type="text" id="promptInput" value="${defaultValue}"
                               style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem; margin-bottom: 24px; font-family: inherit;"
                               placeholder="Enter value...">
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button id="cancelBtn" class="btn btn-secondary" style="padding: 10px 20px;">Cancel</button>
                            <button id="submitBtn" class="btn btn-primary" style="padding: 10px 20px;">Submit</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                const input = modal.querySelector('#promptInput');
                input.focus();
                input.select();

                const submit = () => {
                    const value = input.value.trim();
                    modal.remove();
                    resolve(value || null);
                };

                modal.querySelector('#submitBtn').onclick = submit;
                modal.querySelector('#cancelBtn').onclick = () => {
                    modal.remove();
                    resolve(null);
                };
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') submit();
                    if (e.key === 'Escape') {
                        modal.remove();
                        resolve(null);
                    }
                };
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                };
            });
        }

        // QR Code Customization Editor
        async function showQRCustomizationEditor(qrId, qrType) {
            const qr = qrType === 'dynamic'
                ? dynamicQRs.find(q => q.qrId === qrId)
                : staticQRs.find(q => q.id === qrId);

            if (!qr) {
                showToast('QR code not found', 'error');
                return;
            }

            const customization = qr.customization || {};
            const fgColor = customization.foregroundColor || '#000000';
            const bgColor = customization.backgroundColor || '#FFFFFF';
            const borderWidth = customization.borderWidth || 0;
            const borderColor = customization.borderColor || '#000000';
            const borderStyle = customization.borderStyle || 'solid';
            const textAbove = customization.textAbove || '';
            const textBelow = customization.textBelow || '';
            const size = customization.size || 300;

            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px; overflow-y: auto;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 900px; width: 100%; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800); margin: 0 0 24px 0;">🎨 Customize QR Code</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- Left Column: Controls -->
                            <div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">Foreground Color</label>
                                    <input type="color" id="editFgColor" value="${fgColor}"
                                           style="width: 100%; height: 50px; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer;">
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">Background Color</label>
                                    <input type="color" id="editBgColor" value="${bgColor}"
                                           style="width: 100%; height: 50px; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer;">
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">QR Code Size</label>
                                    <select id="editSize" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem; font-family: inherit;">
                                        <option value="200" ${size === 200 ? 'selected' : ''}>Small (200x200)</option>
                                        <option value="300" ${size === 300 ? 'selected' : ''}>Medium (300x300)</option>
                                        <option value="400" ${size === 400 ? 'selected' : ''}>Large (400x400)</option>
                                        <option value="500" ${size === 500 ? 'selected' : ''}>Extra Large (500x500)</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">Border Width (px)</label>
                                    <input type="number" id="editBorderWidth" value="${borderWidth}" min="0" max="20"
                                           style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem; font-family: inherit;">
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">Border Color</label>
                                    <input type="color" id="editBorderColor" value="${borderColor}"
                                           style="width: 100%; height: 50px; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer;">
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">Border Style</label>
                                    <select id="editBorderStyle" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem; font-family: inherit;">
                                        <option value="solid" ${borderStyle === 'solid' ? 'selected' : ''}>Solid</option>
                                        <option value="dashed" ${borderStyle === 'dashed' ? 'selected' : ''}>Dashed</option>
                                        <option value="dotted" ${borderStyle === 'dotted' ? 'selected' : ''}>Dotted</option>
                                        <option value="double" ${borderStyle === 'double' ? 'selected' : ''}>Double</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">Text Above QR Code</label>
                                    <input type="text" id="editTextAbove" value="${textAbove}" maxlength="50" placeholder="e.g., Scan to visit"
                                           style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem; font-family: inherit;">
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700);">Text Below QR Code</label>
                                    <input type="text" id="editTextBelow" value="${textBelow}" maxlength="50" placeholder="e.g., www.example.com"
                                           style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem; font-family: inherit;">
                                </div>
                            </div>

                            <!-- Right Column: Live Preview -->
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">Live Preview</label>
                                <div id="customizationPreview" style="background: #f8fafc; border: 2px solid var(--gray-300); border-radius: 12px; padding: 30px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                                    <div style="color: var(--gray-500);">Adjust settings to preview</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--gray-200);">
                            <button id="cancelCustomBtn" class="btn btn-secondary" style="padding: 12px 24px;">Cancel</button>
                            <button id="previewCustomBtn" class="btn btn-secondary" style="padding: 12px 24px;">🔄 Preview</button>
                            <button id="saveCustomBtn" class="btn btn-primary" style="padding: 12px 24px;">💾 Save Changes</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Preview function
                const updatePreview = () => {
                    const preview = modal.querySelector('#customizationPreview');
                    const fgColor = modal.querySelector('#editFgColor').value;
                    const bgColor = modal.querySelector('#editBgColor').value;
                    const borderWidth = parseInt(modal.querySelector('#editBorderWidth').value);
                    const borderColor = modal.querySelector('#editBorderColor').value;
                    const borderStyle = modal.querySelector('#editBorderStyle').value;
                    const textAbove = modal.querySelector('#editTextAbove').value;
                    const textBelow = modal.querySelector('#editTextBelow').value;
                    const size = parseInt(modal.querySelector('#editSize').value);

                    try {
                        preview.innerHTML = '';

                        // Create wrapper
                        const wrapper = document.createElement('div');
                        wrapper.style.display = 'inline-block';
                        wrapper.style.padding = borderWidth + 'px';
                        wrapper.style.border = borderWidth > 0 ? `${borderWidth}px ${borderStyle} ${borderColor}` : 'none';
                        wrapper.style.backgroundColor = bgColor;
                        wrapper.style.textAlign = 'center';

                        // Add text above
                        if (textAbove) {
                            const textAboveEl = document.createElement('div');
                            textAboveEl.textContent = textAbove;
                            textAboveEl.style.marginBottom = '10px';
                            textAboveEl.style.fontWeight = '600';
                            textAboveEl.style.color = fgColor;
                            wrapper.appendChild(textAboveEl);
                        }

                        // Create QR code
                        const canvas = document.createElement('canvas');
                        wrapper.appendChild(canvas);

                        // Add text below
                        if (textBelow) {
                            const textBelowEl = document.createElement('div');
                            textBelowEl.textContent = textBelow;
                            textBelowEl.style.marginTop = '10px';
                            textBelowEl.style.fontWeight = '600';
                            textBelowEl.style.color = fgColor;
                            wrapper.appendChild(textBelowEl);
                        }

                        const qrious = new QRious({
                            element: canvas,
                            value: qr.content || qr.destinationUrl || 'https://example.com',
                            size: Math.min(size, 300), // Limit preview size
                            background: bgColor,
                            foreground: fgColor,
                            level: 'H'
                        });

                        preview.appendChild(wrapper);
                    } catch (error) {
                        console.error('Preview error:', error);
                        preview.innerHTML = '<div style="color: var(--error);">Preview error</div>';
                    }
                };

                // Add event listeners for live preview
                modal.querySelector('#previewCustomBtn').onclick = updatePreview;
                modal.querySelectorAll('#editFgColor, #editBgColor, #editSize, #editBorderWidth, #editBorderColor, #editBorderStyle, #editTextAbove, #editTextBelow').forEach(input => {
                    input.addEventListener('change', updatePreview);
                });

                // Initial preview
                updatePreview();

                // Save button
                modal.querySelector('#saveCustomBtn').onclick = async () => {
                    const newCustomization = {
                        foregroundColor: modal.querySelector('#editFgColor').value,
                        backgroundColor: modal.querySelector('#editBgColor').value,
                        size: parseInt(modal.querySelector('#editSize').value),
                        borderWidth: parseInt(modal.querySelector('#editBorderWidth').value),
                        borderColor: modal.querySelector('#editBorderColor').value,
                        borderStyle: modal.querySelector('#editBorderStyle').value,
                        textAbove: modal.querySelector('#editTextAbove').value,
                        textBelow: modal.querySelector('#editTextBelow').value
                    };

                    try {
                        if (qrType === 'dynamic') {
                            // Update dynamic QR via API
                            const authToken = localStorage.getItem('snapitqr_token');
                            const response = await fetch(`https://api.snapitqr.com/qr-codes/${qrId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${authToken}`
                                },
                                body: JSON.stringify({ customization: newCustomization })
                            });

                            if (response.ok) {
                                showToast('QR code customization updated!', 'success');
                                await refreshDashboard();
                                modal.remove();
                                resolve(true);
                            } else {
                                const error = await response.json();
                                showToast(error.error || 'Failed to update customization', 'error');
                            }
                        } else {
                            // Update static QR in localStorage
                            const qrs = getStaticQRCodes();
                            const index = qrs.findIndex(q => q.id === qrId);
                            if (index !== -1) {
                                qrs[index].customization = newCustomization;
                                localStorage.setItem(QR_STORAGE_KEY, JSON.stringify(qrs));
                                showToast('QR code customization updated!', 'success');
                                await refreshDashboard();
                                modal.remove();
                                resolve(true);
                            }
                        }
                    } catch (error) {
                        console.error('Save customization error:', error);
                        showToast('Failed to save customization', 'error');
                    }
                };

                // Cancel button
                modal.querySelector('#cancelCustomBtn').onclick = () => {
                    modal.remove();
                    resolve(false);
                };

                // Click outside to close
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };
            });
        }

        // Toast notification system
        function showToast(message, type = 'info', duration = 4000) {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <span style="font-size: 1.2rem;">${icons[type] || icons.info}</span>
                    <span style="flex: 1;">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-400);">×</button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
        }

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Contact and Feedback Modal Functions
        function openContactModal() {
            const modal = document.getElementById('contactModal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(1)';
            }, 10);
        }

        function closeContactModal() {
            const modal = document.getElementById('contactModal');
            modal.style.opacity = '0';
            modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(0.9)';
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('contactForm').reset();
            }, 300);
        }

        function openFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(1)';
            }, 10);
        }

        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.style.opacity = '0';
            modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(0.9)';
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('feedbackForm').reset();
            }, 300);
        }

        // Close modals on outside click
        document.getElementById('contactModal').addEventListener('click', function(e) {
            if (e.target === this) closeContactModal();
        });

        document.getElementById('feedbackModal').addEventListener('click', function(e) {
            if (e.target === this) closeFeedbackModal();
        });

        // Intercept contact link clicks
        document.querySelectorAll('a[href="/contact"], a[href*="contact"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                openContactModal();
            });
        });

        // Submit Contact Form
        async function submitContactForm(e) {
            e.preventDefault();
            const btn = document.getElementById('contactSubmitBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Sending...';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);
                const response = await fetch('https://api.web3forms.com/submit', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Message sent successfully! We\'ll get back to you soon.', 'success');
                    closeContactModal();
                } else {
                    throw new Error(data.message || 'Submission failed');
                }
            } catch (error) {
                console.error('Contact form error:', error);
                showToast('Failed to send message. Please try again.', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Submit Feedback Form
        async function submitFeedbackForm(e) {
            e.preventDefault();
            const btn = document.getElementById('feedbackSubmitBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Submitting...';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);
                const response = await fetch('https://api.web3forms.com/submit', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Thank you for your feedback!', 'success');
                    closeFeedbackModal();
                } else {
                    throw new Error(data.message || 'Submission failed');
                }
            } catch (error) {
                console.error('Feedback form error:', error);
                showToast('Failed to submit feedback. Please try again.', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Add global feedback button (floating button in corner)
        // Feedback button removed - use footer link instead

        // Bulk Upload Functions
        function showBulkUploadModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkUploadModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-top: 0;">📤 Bulk Upload</h2>
                    <p style="color: #666; margin-bottom: 20px;">Upload a CSV file with URLs to create multiple QR codes or short links at once.</p>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Upload Type:</label>
                        <select id="bulkUploadType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="url">Short URLs</option>
                            <option value="qr">QR Codes</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">CSV File:</label>
                        <input type="file" id="bulkCsvFile" accept=".csv" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <small style="color: #666; display: block; margin-top: 8px;">Format: url,title (one per line)</small>
                    </div>

                    <div id="bulkPreview" style="margin-bottom: 20px; display: none;">
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Preview:</h3>
                        <div id="bulkPreviewContent" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #f9f9f9;"></div>
                    </div>

                    <div id="bulkProgress" style="margin-bottom: 20px; display: none;">
                        <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden; height: 30px;">
                            <div id="bulkProgressBar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;"></div>
                        </div>
                        <div id="bulkProgressText" style="margin-top: 8px; text-align: center; color: #666;"></div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeBulkUploadModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button id="bulkUploadBtn" onclick="processBulkUpload()" style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">Upload</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add file change listener for preview
            document.getElementById('bulkCsvFile').addEventListener('change', previewBulkUpload);
        }

        function closeBulkUploadModal() {
            const modal = document.getElementById('bulkUploadModal');
            if (modal) modal.remove();
        }

        async function previewBulkUpload() {
            const fileInput = document.getElementById('bulkCsvFile');
            const file = fileInput.files[0];

            if (!file) return;

            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());

            const preview = document.getElementById('bulkPreview');
            const previewContent = document.getElementById('bulkPreviewContent');

            previewContent.innerHTML = lines.slice(0, 10).map((line, i) => {
                const [url, title] = line.split(',').map(s => s.trim());
                return `<div style="padding: 5px 0; border-bottom: 1px solid #eee;"><strong>${i + 1}.</strong> ${title || 'Untitled'} - ${url}</div>`;
            }).join('');

            if (lines.length > 10) {
                previewContent.innerHTML += `<div style="padding: 10px 0; color: #666; font-style: italic;">...and ${lines.length - 10} more items</div>`;
            }

            preview.style.display = 'block';
        }

        async function processBulkUpload() {
            const fileInput = document.getElementById('bulkCsvFile');
            const uploadType = document.getElementById('bulkUploadType').value;
            const file = fileInput.files[0];

            if (!file) {
                showToast('Please select a CSV file', 'error');
                return;
            }

            const authToken = localStorage.getItem('accessKey') || localStorage.getItem('snapiturl_token');
            if (!authToken) {
                showToast('Please log in first', 'error');
                return;
            }

            try {
                // Parse CSV
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());

                if (lines.length === 0) {
                    showToast('CSV file is empty', 'error');
                    return;
                }

                if (lines.length > 100) {
                    showToast('Maximum 100 items per batch. Please split your file.', 'error');
                    return;
                }

                const items = lines.map(line => {
                    const [url, title] = line.split(',').map(s => s.trim());
                    return { url, title: title || url };
                });

                // Show progress
                document.getElementById('bulkProgress').style.display = 'block';
                document.getElementById('bulkUploadBtn').disabled = true;
                document.getElementById('bulkProgressText').textContent = 'Uploading...';

                // Determine API endpoint - use snapiturl API for URL shortening
                const endpoint = uploadType === 'qr' ? '/qr-codes/bulk' : '/short-urls/bulk';
                const apiUrl = `https://api.snapiturl.com${endpoint}`;

                // Upload
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ items })
                });

                const result = await response.json();

                if (response.ok) {
                    const progressBar = document.getElementById('bulkProgressBar');
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    document.getElementById('bulkProgressText').textContent = `Successfully created ${result.count} ${uploadType === 'qr' ? 'QR codes' : 'short URLs'}!`;

                    setTimeout(() => {
                        closeBulkUploadModal();
                        refreshDashboard();
                        showToast(`Created ${result.count} items successfully!`, 'success');
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Bulk upload error:', error);
                showToast('Failed to upload: ' + error.message, 'error');
                document.getElementById('bulkUploadBtn').disabled = false;
            }
        }
    </script>
</body>
</html>